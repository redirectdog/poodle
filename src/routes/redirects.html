<svelte:head>
	<title>My Redirects</title>
</svelte:head>

<h1>My Redirects</h1>
<button on:click="newRedirect()">New</button>
<ul>
	{#each data as redirect}
	<li>{redirect.host} -&gt; {redirect.destination}</li>
	{/each}
</ul>

<script>
	export default {
		preload() {
			return this.fetch("/api/users/~me/redirects", {credentials: "include"})
				.then(res => res.json())
				.then(res => {
					console.log(res);
					return {data: res};
				});
		},
		methods: {
			newRedirect() {
				const host = prompt("Host?");
				const destination = prompt("Destination");

				fetch(
					"/api/users/~me/redirects",
					{
						method: "POST",
						body: JSON.stringify({host, destination}),
					}
				)
					.then(res => res.text())
					.then(idStr => parseInt(idStr, 10))
					.then(id => {
						const { data } = this.get();

						data.push({id, host, destination});

						this.set({data});
					});
			}
		}
	}
</script>
