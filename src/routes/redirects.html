<svelte:head>
	<title>My Redirects</title>
</svelte:head>

<h1>My Redirects</h1>
<button on:click="newRedirect()">New</button>
<table>
	<tr>
		<th>Redirect</th>
		<th>Total Visits</th>
		<th>Visits in the Last Month</th>
	</tr>
	{#each data as redirect}
	<tr>
		<td>
			{redirect.host} -&gt; {redirect.destination}
		</td>
		<td>{redirect.visits_total}</td>
		<td>{redirect.visits_month}</td>
	</tr>
	{/each}
</table>

<script>
	import fetchWithError from "../util/fetchWithError";
	import showError from "../util/showError";

	export default {
		preload() {
			return this.fetch("/api/users/~me/redirects", {credentials: "include"})
				.then(res => res.json())
				.then(res => {
					return {data: res};
				});
		},
		methods: {
			newRedirect() {
				const host = prompt("Host?");
				const destination = prompt("Destination");

				fetchWithError(
					"/api/users/~me/redirects",
					{
						method: "POST",
						body: JSON.stringify({host, destination}),
					}
				)
					.then(res => res.text())
					.then(idStr => parseInt(idStr, 10))
					.then(id => {
						const { data } = this.get();

						data.push({id, host, destination});

						this.set({data});
					})
					.catch(showError);
			}
		}
	}
</script>
